import{cN as Tt,ar as j,dv as Z,a7 as p,a8 as m,ab as Mt,bP as Qt,hj as Qe,we as Zt,wf as Jt,jm as ve,aw as ie,eb as $t,ax as N,eL as Kt,gu as ei,kO as Ve,pU as Pt,l4 as J,e9 as _e,dZ as W,aS as Ze,aZ as Je,aY as Te,aP as ne,jo as Ke,e0 as Dt,wg as ti,wh as ii,b4 as G,qG as At,aj as le,wi as ri,wj as et,gk as tt,a_ as Ne,l0 as it,k$ as si,ea as oi,iE as ai,kK as he,dW as U,oX as ce,l5 as ni,e1 as Q,a$ as rt,b1 as xe,e3 as li,ai as hi,vJ as ci,wc as ui,dg as st,ip as be,vI as di,jk as pi,vP as k,cj as Ue,_ as fi,kq as ot,kE as gi,jf as Et,ec as we,c0 as mi,dY as Me,cb as vi,ni as _i,im as wi,pT as yi,b8 as xi,b2 as Rt,at as bi,wk as at}from"./index-D1XG4HjB.js";import{t as Oi}from"./NestedMap-GuqgquCN.js";import{t as Ci}from"./glUtil-DP-5IwTT.js";import{n as z,b as $e}from"./NormalAttribute.glsl-CybsBnC1.js";import{O as Si}from"./basicInterfaces-CZwQPxTp.js";import{x as Ti,ax as Mi,A as q,C as $i,a5 as Pi,E as Di,a3 as Ai,s as Ei,a1 as Ri,a2 as Ii,a6 as zi,e as ue,aq as nt,o as Pe,w as Fi,ay as ji,h as Li,j as lt,az as Bi,P as re,J as Hi,K as Vi,aA as Ni,aa as Gi,W as A,af as Ui,ag as qi,ah as Wi,Y as ki,m as Yi,aB as Xi,aC as Qi,aD as ht,aE as Zi,aF as Ji,aG as Ki,aH as er,Q as tr,v as ir,aI as rr,aJ as sr,aK as or,aL as ar,aM as ct,aN as ut,aO as nr}from"./Geometry-Bh5RbOwn.js";import{s as ye}from"./Util-D6ZLmPBV.js";import{H as lr,N as hr,L as cr}from"./Octree-DZHZCvqF.js";import{o as ur}from"./VertexArrayObject-Dh-ohhjh.js";import{o as dr}from"./floatRGBA-DFx1hZ0s.js";import{x as pr}from"./BufferView-ydqOnvgn.js";import{H as fr}from"./InterleavedLayout-DVDYEL7B.js";import{d as It,e as gr,f as mr,b as vr,p as _r}from"./dehydratedFeatureUtils-D5iae98Z.js";import{e as x}from"./VertexAttribute-Cq4MnHjR.js";import{p as wr,B as yr,o as xr,g as br}from"./renderState-ev5_bP7L.js";import{a as Or}from"./BindType-BmZEZMMh.js";import{o as w,r as E}from"./interfaces-DDtDqZYj.js";let Cr=class extends Ti{constructor(e,i){super(e,"vec4",Or.Draw,(r,s,o)=>r.setUniform4fv(e,i(s,o)))}};const Sr={required:[]};z.Depth;let zt=class extends Tt{precompile(e){const i=this.acquireTechniques(e);return Mr(i),i!=null}consumes(){return Sr}get usedMemory(){return 0}get isDecoration(){return!1}get running(){return!1}modify(e){}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(e){}queryRenderOccludedState(e){return!1}},Tr=class extends zt{},Ls=class extends zt{};function Mr(t){Array.isArray(t)?t.forEach(e=>e==null?void 0:e.release()):t==null||t.release()}let $r=class{constructor(e,i){this._material=e,this._repository=i,this._map=new Map}dispose(){this._map.forEach((e,i)=>{e!=null&&this._repository.release(this._material,i)})}load(e,i,r){const s=this._material.produces.get(i);if(!(s!=null&&s(r)))return null;this._map.has(r)||this._map.set(r,this._repository.acquire(this._material,i,r));const o=this._map.get(r);if(o!=null){if(o.ensureResources(e)===Si.LOADED)return o;this._repository.requestRender()}return null}},Pr=class extends Mi{constructor(e=j()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}};var dt,Y;(function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"})(dt||(dt={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}(Y||(Y={}));let qe=class{constructor(e=0,i=0){this.from=e,this.to=i}get numElements(){return this.to-this.from}};function pt(t){const e=new Map;t.forAll(r=>e.set(r.from,r));let i=!0;for(;i;){i=!1;for(let r=0;r<t.length;++r){const s=t.data[r],o=e.get(s.to);if(!o)return;s.to=o.to,e.delete(o.from),t.removeUnordered(o),i=!0}}}let ft=class extends qe{constructor(e,i,r){super(i,r),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}foreachHighlightGroup(e){this.isVisible&&this.geometry.foreachHighlightGroup(e)}get hasOccludees(){return this.geometry.occludees!=null}},Dr=class{constructor(){this.first=0,this.count=0}},Ar=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new Z({allocator:e=>e||new qe,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightGroups=new Set,this.drawCommandsDefault=de(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=de(),this.drawCommandsShadowHighlightRest=de()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightGroups.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightGroups.clear()}updateIfDrawCommandsDirty(e){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const i of this.instances.values())this.updateDrawState(i);this.updateDrawCommands(e)}}addInstance(e,i){this.deleteInstance(e),this._instances.set(e,i),this._numElements+=i.numElements}deleteInstance(e){const i=this._instances.get(e);i&&(this._numElements-=i.numElements,this._instances.delete(e))}updateInstance(e,i,r){const s=this._instances.get(e);s&&(this._numElements-=s.numElements,s.from=i,s.to=r,this._numElements+=s.numElements)}updateDrawState(e){e.isVisible?(e.foreachHighlightGroup(i=>this.highlightGroups.add(i)),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlights.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;if(!this.needsMultipleCommands()){const s=this.drawCommandsDefault.pushNew(),o=this.holes.front();return this.vao!=null&&this.holes.length===1&&o.to===Math.floor(this.vao.byteSize/e)?(s.first=0,void(s.count=o.from)):(s.first=1/0,s.count=0,this._instances.forEach(a=>{s.first=Math.min(s.first,a.from),s.count=Math.max(s.count,a.to)}),void(s.count-=s.first))}const i=Array.from(this._instances.values()).sort((s,o)=>s.from===o.from?s.to-o.to:s.from-o.from),{drawCommandsHighlights:r}=this;for(const s of i)s.isVisible&&(De(s.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,s),s.hasHighlights?s.foreachHighlightGroup(o=>{let a=r.get(o);a||(a=de(),r.set(o,a)),De(a,s)}):De(this.drawCommandsShadowHighlightRest,s))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function Er(t){return t.vao!=null}function de(){return new Z({allocator:t=>t||new Dr,deallocator:t=>t})}function De(t,e){const i=t.back();if(i==null){const r=t.pushNew();return r.first=e.from,void(r.count=e.numElements)}if(Rr(i,e)){const r=e.from-i.first+e.numElements;i.count=r}else{const r=t.pushNew();r.first=e.from,r.count=e.numElements}}function Rr(t,e){return t.first+t.count>=e.from}let Ir=class{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(i=>i.instances.has(e))}},Ae=class extends Tr{get _hasAnyHighlight(){return this._highlightGroups.size>0}constructor(e){super(e),this._dataByOrigin=new Map,this._drawParameters=new Pr,this._highlightGroups=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=Qt(this._glMaterials),this._dataByOrigin.forEach(e=>e.dispose()),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this.material.produces.forEach((e,i)=>{this._produces.set(i,r=>!(this._dataByOrigin.size===0||!(r!==z.Highlight&&r!==z.ShadowHighlight||this._hasAnyHighlight))&&e(r))})}initializeRenderContext(e,i){this._glMaterials=new $r(this.material,i??e.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,Ci(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(e){return this.material.queryRenderOccludedState(e)}get numGeometries(){let e=0;return this._dataByOrigin.forEach(i=>e+=i.buffers.reduce((r,s)=>r+s.instances.size,0)),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach(i=>e+=i.buffers.reduce((r,s)=>r+s.vao.usedMemory,0)),e}forEachGeometry(e){this._dataByOrigin.forEach(i=>i.buffers.forEach(r=>r.instances.forEach(({geometry:s})=>e(s))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const i=this._bufferWriter;if(i==null)return;const r=i.vertexBufferLayout.stride/4;for(const s of e){const o=s.renderGeometry,a=this._dataByOrigin.get(o.localOrigin.id),l=a==null?void 0:a.findBuffer(o.id);if(l==null)return;const n=l.instances.get(o.id);if(s.updateType&(Y.GEOMETRY|Y.TRANSFORMATION)){const c=ge(i.elementCount(n.geometry.geometry.attributes)*r),h=i.vertexBufferLayout.createView(c.buffer);this._writeGeometry(o,h,0),l.vao.vertexBuffers.get("geometry").setSubData(c,n.from*r,0,n.numElements*r)}s.updateType&(Y.HIGHLIGHT|Y.OCCLUDEE|Y.VISIBILITY)&&(l.drawCommandsDirty=!0)}}_computeDeltas(e,i){const r=new Oi;for(const s of e){const o=s.localOrigin;if(o==null)continue;let a=r.get(o.id,null);a==null&&(a=new gt(o.vec3),r.set(o.id,null,a)),a.changes.push(s)}for(const s of i){const o=s.localOrigin;if(o==null)continue;const a=this._dataByOrigin.get(o.id),l=a==null?void 0:a.findBuffer(s.id);if(l==null)continue;let n=r.get(o.id,l);n==null&&(n=new gt(o.vec3),r.set(o.id,l,n)),n.changes.push(s)}return r}_addAndRemoveGeometries(e,i){if(this._bufferWriter==null||this._vaoCache==null)return;const{_bufferWriter:r,_dataByOrigin:s}=this,o=r.vertexBufferLayout.stride/4,a=this._computeDeltas(e,i);a.forEach((l,n)=>{const c=l.get(null),h=(c==null?void 0:c.changes)??[];a.delete(n,null);let u=s.get(n);if(l.forEach((f,d)=>{if(a.delete(n,d),d==null)return void ye(!1,"No VAO for removed geometries");if(d.instances.size===f.changes.length)return this._vaoCache.deleteVao(d.vao),Qe(u.buffers,d),void(u.buffers.length===0&&h.length===0&&s.delete(n));const _=d.numElements,y=d.vao.byteSize/4,O=h.reduce((C,P)=>C+r.elementCount(P.geometry.attributes),0),S=f.changes.reduce((C,P)=>C+r.elementCount(P.geometry.attributes),0),M=Math.min((_+O-S)*o,fe),T=M>y;M>Oe&&M<y/2?(f.changes.forEach(({id:C})=>d.deleteInstance(C)),d.instances.forEach(({geometry:C})=>h.push(C)),this._vaoCache.deleteVao(d.vao),Qe(u.buffers,d)):T?this._applyAndRebuild(d,h,f):this._applyRemoves(d,f)}),h.length>0)for(u==null&&(u=new Ir(c.origin),s.set(n,u)),u.buffers.forEach(f=>this._applyAdds(f,h));h.length>0;)u.buffers.push(this._applyAndRebuild(new Ar,h,null))})}_updateDrawCommands(){this._highlightGroups.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach(e=>{e.buffers.forEach(i=>{i.updateIfDrawCommandsDirty(this._bufferWriter.vertexBufferLayout.stride),i.hasHighlights&&Zt(this._highlightGroups,i.highlightGroups),this._hasOccludees=this._hasOccludees||i.hasOccludees})})}_applyAndRebuild(e,i,r){if(r)for(const _ of r.changes)e.deleteInstance(_.id);const s=this._bufferWriter,o=s.vertexBufferLayout.stride,a=o/4,l=Math.floor(fe/a);let n=e.numElements;for(;i.length>0;){const _=i.pop(),y=s.elementCount(_.geometry.attributes);if(n+y>l&&n>0){i.push(_);break}n+=y;const O=new ft(_,0,0);ye(e.instances.get(_.id)==null),e.addInstance(_.id,O)}const c=n*a,h=ge(c),u=s.vertexBufferLayout.createView(h.buffer);let f=0;e.resetInstanceSummary(),e.instances.forEach((_,y)=>{this._writeGeometry(_.geometry,u,f);const O=f;f+=s.elementCount(_.geometry.geometry.attributes),e.updateInstance(y,O,f),e.updateDrawState(_)}),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(vt(c)),e.vao.vertexBuffers.get("geometry").setSubData(h,0,0,f*a),e.holes.clear();const d=e.holes.pushNew();return d.from=f,d.to=Math.floor(e.vao.byteSize/o),e.updateDrawCommands(o),e}_applyRemoves(e,i){if(i.changes.length===0||this._bufferWriter==null)return;for(const l of i.changes){const n=l.id,c=e.instances.get(n);if(!c)continue;e.deleteInstance(n);const h=V.back();if(h){if(h.to===c.from){h.to=c.to;continue}if(h.from===c.to){h.from=c.from;continue}}const u=V.pushNew();u.from=c.from,u.to=c.to}pt(V);const r=this._bufferWriter.vertexBufferLayout.stride/4,s=V.reduce((l,n)=>Math.max(l,n.numElements),0)*r,o=ge(s);o.fill(0,0,s);const a=e.vao.vertexBuffers.get("geometry");V.forAll(l=>a.setSubData(o,l.from*r,0,l.numElements*r)),e.holes.pushArray(V.data,V.length),V.forAll((l,n)=>V.data[n]=null),V.clear(),e.drawCommandsDirty=!0}_applyAdds(e,i){if(i.length===0||this._bufferWriter==null)return;if(!Er(e))return void this._applyAndRebuild(e,i,null);const r=this._bufferWriter,s=r.vertexBufferLayout.stride/4,o=e.numElements,a=i.reduce((S,M)=>S+r.elementCount(M.geometry.attributes),0),l=Math.min((o+a)*s,fe),n=4*l;if(e.vao.byteSize<vt(fe-Oe)&&n>e.vao.byteSize)return void this._applyAndRebuild(e,i,null);pt(e.holes);const c=new Array;for(const S of i){const M=r.elementCount(S.geometry.attributes),T=zr(e.holes,M);c.push(T)}const h=e.vao.vertexBuffers.get("geometry");let u=0,f=0,d=0;const _=ge(l),y=r.vertexBufferLayout.createView(_.buffer);i.forEach((S,M)=>{const T=c[M];if(T==null)return;if(d!==T){const $=d-f;$>0&&h.setSubData(_,f*s,0,$*s),f=T,u=0}const C=r.elementCount(S.geometry.attributes);this._writeGeometry(S,y,u),u+=C,d=T+C;const P=new ft(S,T,T+C);ye(e.instances.get(S.id)==null),e.addInstance(S.id,P),e.drawCommandsDirty=!0});const O=d-f;O>0&&h.setSubData(_,f*s,0,O*s),Jt(i,(S,M)=>c[M]==null)}_writeGeometry(e,i,r){this._bufferWriter!=null&&(ve(X,e.transformation),X[12]-=e.localOrigin.vec3[0],X[13]-=e.localOrigin.vec3[1],X[14]-=e.localOrigin.vec3[2],ie(pe,X),$t(pe,pe),this._bufferWriter.write(X,pe,e.geometry.attributes,e.geometry.objectAndLayerIdColor,i,r))}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){var d;if(!this.material.shouldRender(e))return null;const{output:i,bind:r}=e,s=this.material.produces.get(r.slot);if(!(s!=null&&s(i)))return null;const{highlightGroupName:o,slot:a}=r,l=i===z.ShadowHighlight,n=i===z.Highlight,c=n||l,h=_=>c&&(this._highlightGroups.size===0||n&&!!o&&!_.has(o));if(h(this._highlightGroups))return null;const u=i===z.ShadowExcludeHighlight,f=!(c||u);for(const{buffers:_}of this._dataByOrigin.values())for(const y of _){if(h(y.highlightGroups))continue;const O=l?y.drawCommandsHighlights.size>0:c?o?y.drawCommandsHighlights.get(o):y.drawCommandsHighlights.size>0:((d=(u&&y.needsMultipleCommands()?y.drawCommandsShadowHighlightRest:y.drawCommandsDefault)||null)==null?void 0:d.length)??!1,S=f&&y.drawCommandsOccludees||null;if(O||S!=null&&S.length){const M=this._glMaterials.load(e.rctx,a,i),T=M==null?void 0:M.beginSlot(r);if(T)return T}}return null}render(e,i){const{output:r,bind:s}=e,{slot:o,highlightGroupName:a}=s,l=r===z.Highlight;if(l&&!a)return;const n=r===z.ShadowHighlight,c=l||n,h=r===z.ShadowExcludeHighlight,u=!(c||h),f=o===q.OCCLUDER_MATERIAL||o===q.TRANSPARENT_OCCLUDER_MATERIAL?o:null,{rctx:d}=e;d.runAppleAmdDriverHelper();const _=d.bindTechnique(i,s,this.material.parameters);for(const y of this._dataByOrigin.values())for(const O of y.buffers){if(l&&(!O.hasHighlights||!O.drawCommandsHighlights.has(a))||n&&!O.hasHighlights)continue;const S=()=>{const $=[];for(const H of O.drawCommandsHighlights.values())$.push(H);return $},M=c&&!n?O.drawCommandsHighlights.get(a)??null:null,T=n?S():c?M?[M]:_t:(h&&O.needsMultipleCommands()?[O.drawCommandsShadowHighlightRest]:[O.drawCommandsDefault])||_t,C=T.some($=>$.length>0),P=u&&O.drawCommandsOccludees||null;if(C||P!=null&&P.length){if(this._drawParameters.origin=y.origin,_.bindDraw(s,this.material.parameters,this._drawParameters),i.ensureAttributeLocations(O.vao),d.bindVAO(O.vao),C)for(const $ of T)d.setPipelineState(i.getPipeline(!1,f)),$.forAll(H=>d.drawArrays(i.primitiveType,H.first,H.count));P!=null&&P.length&&(d.setPipelineState(i.getPipeline(!0,f)),P.forAll($=>d.drawArrays(i.primitiveType,$.first,$.count)))}}}get test(){}};p([m({constructOnly:!0})],Ae.prototype,"material",void 0),Ae=p([Mt("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],Ae);class gt{constructor(e){this.origin=e,this.changes=new Array}}function zr(t,e){const i=t.find(s=>s.numElements>=e);if(i==null)return null;const r=i.from;return i.from+=e,i.from>=i.to&&t.removeUnordered(i),r}const X=N(),pe=N(),V=new Z({allocator:t=>t||new qe,deallocator:null}),Oe=65536,Ee=4*Oe,mt=1024,Ft=16777216,fe=Ft/4;let Re=new Float32Array(Oe);function ge(t){return Re.length<t&&(Re=new Float32Array(t)),Re}function vt(t){const e=4*t;return e<=mt?mt:e<Ee?Kt(e):Math.max(Math.min(Math.ceil(1.5*e/Ee)*Ee,Ft),e)}const _t=[];function Fr(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/e)}function jr(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/i)}function Lr(t,e,i){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}function Br(t,e,i){return 2*Math.atan(i*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}let Ys=class{constructor(){this.adds=new Z,this.removes=new Z,this.updates=new Z({allocator:e=>e||new Hr,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},Hr=class{},Vr=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}};var wt,b;function Js(t){const e=new Map,i=r=>{let s=e.get(r);return s||(s=new Vr,e.set(r,s)),s};return t.removes.forAll(r=>{Ie(r)&&i(r.material).removes.push(r)}),t.adds.forAll(r=>{Ie(r)&&i(r.material).adds.push(r)}),t.updates.forAll(r=>{Ie(r.renderGeometry)&&i(r.renderGeometry.material).updates.push(r)}),e}function Ie(t){return t.geometry.indexCount>=1}(function(t){t[t.Default=0]="Default",t[t.Screenshot=1]="Screenshot",t[t.ObjectAndLayerID=2]="ObjectAndLayerID"})(wt||(wt={})),function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"}(b||(b={}));var Ge;let g=Ge=class extends Tt{constructor(t){super(t),this._ray=ei(),this._viewport=Ve(0,0,1,1),this._padding=Ve(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Pt(1,1e3),this._viewDirty=!0,this._viewMatrix=N(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=N(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=N(),this._frustumDirty=!0,this._frustum=lr(),this._fullViewport=J(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=j(),this._up=j(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get rows(){return this._rows}set rows(t){this._rows=Math.max(1,t)}get columns(){return this._columns}set columns(t){this._columns=Math.max(1,t)}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return _e(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){ve(this._viewMatrix,t),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),W(j(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),W(j(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),W(j(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const t=Ze(J(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&Je(t,e)?e:t}get screenPadding(){if(this.pixelRatio===1)return this._padding;const t=Ze(J(),this._padding,1/this.pixelRatio),e=this._get("screenPadding");return e&&Je(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[b.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[b.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[b.RIGHT]+this._padding[b.LEFT]}set fullWidth(t){this.width=t-(this._padding[b.RIGHT]+this._padding[b.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[b.TOP]+this._padding[b.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[b.TOP]+this._padding[b.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[b.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[b.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){Te(this._padding,t)||(this._viewport[0]+=t[b.LEFT]-this._padding[b.LEFT],this._viewport[1]+=t[b.BOTTOM]-this._padding[b.BOTTOM],this._viewport[2]-=t[b.RIGHT]+t[b.LEFT]-(this._padding[b.RIGHT]+this._padding[b.LEFT]),this._viewport[3]-=t[b.TOP]+t[b.BOTTOM]-(this._padding[b.TOP]+this._padding[b.BOTTOM]),ne(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(Ke(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return ie(N(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||N()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Lr(this._fov,this.width,this.height)}set fovX(t){this._fov=Fr(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Br(this._fov,this.width,this.height)}set fovY(t){this._fov=jr(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return Dt(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(ie(this._viewInverseTransposeMatrix,this.viewMatrix),$t(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){const t=this.width,e=this.height,i=this.near*Math.tan(this.fovY/2)*2,r=i*this._aspect,s=i/this.rows,o=r/this.columns,a=-r/2+this.column*o,l=a+o,n=-i/2+this.row*s,c=n+s,h=ti(N(),a*(1+2*this._padding[b.LEFT]/t),l*(1+2*this._padding[b.RIGHT]/t),n*(1+2*this._padding[b.BOTTOM]/e),c*(1+2*this._padding[b.TOP]/e),this.near,this.far),u=this._get("projectionMatrix");return u&&ii(u,h)?u:h}copyFrom(t){G(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,ne(this._viewport,t.viewport),this.notifyChange("_viewport"),ne(this._padding,t.padding),this.notifyChange("_padding"),At(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.row=t.row,this.column=t.column,this.rows=t.rows,this.columns=t.columns,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(ve(this._viewMatrix,t.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(hr(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(ve(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),ne(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up,this.fov=t.fov}clone(){return new Ge().copyFrom(this)}equals(t){return le(this.eye,t.eye)&&le(this.center,t.center)&&le(this.up,t.up)&&Te(this._viewport,t.viewport)&&Te(this._padding,t.padding)&&ri(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation&&this.row===t.row&&this.column===t.column&&this.rows===t.rows&&this.columns===t.columns}almostEquals(t){const e=Math.max(1,1/this.pixelRatio,1/t.pixelRatio);if(Math.abs(t.fov-this._fov)>=.001||et(t.screenPadding,this.screenPadding)>=e||et(this.screenViewport,t.screenViewport)>=e||this.row!==t.row||this.column!==t.column||this.rows!==t.rows||this.columns!==t.columns)return!1;tt(R,t.eye,t.center),tt(ze,this.eye,this.center);const i=Ne(R,ze),r=it(R),s=it(ze),o=5e-4;return i*i>=(1-1e-10)*r*s&&si(t.eye,this.eye)<Math.max(r,s)*o*o}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(oi(this.viewForward,_e(R,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=ai()){return t[0]=(this.padding[b.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[b.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,i=.5){return t[0]=this.padding[b.LEFT]+this.width*e,t[1]=this.padding[b.BOTTOM]+this.height*i,t[2]=.5,t}setGLViewport(t){const e=this.viewport,i=this.padding;t.setViewport(e[0]-i[3],e[1]-i[2],e[2]+i[1]+i[3],e[3]+i[0]+i[2])}applyProjection(t,e){t!==v&&G(v,t),v[3]=1,he(v,v,this.projectionMatrix);const i=Math.abs(v[3]);U(v,v,1/i);const r=this.fullViewport;e[0]=ce(0,r[0]+r[2],.5+.5*v[0]),e[1]=ce(0,r[1]+r[3],.5+.5*v[1]),e[2]=.5*(v[2]+1),e[3]=i}unapplyProjection(t,e){const i=this.fullViewport;v[0]=(t[0]/(i[0]+i[2])*2-1)*t[3],v[1]=(t[1]/(i[1]+i[3])*2-1)*t[3],v[2]=(2*t[2]-1)*t[3],v[3]=t[3],this.inverseProjectionMatrix!=null&&(he(v,v,this.inverseProjectionMatrix),e[0]=v[0],e[1]=v[1],e[2]=v[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,Fe),this.renderToScreen(Fe,e),e}projectToRenderScreen(t,e){if(v[0]=t[0],v[1]=t[1],v[2]=t[2],v[3]=1,he(v,v,this.viewProjectionMatrix),v[3]===0)return null;const i=v;U(i,i,1/Math.abs(v[3]));const r=this.fullViewport,s=ce(0,r[0]+r[2],.5+.5*i[0]),o=ce(0,r[1]+r[3],.5+.5*i[1]);return"x"in e?(e.x=s,e.y=o):(e[0]=s,e[1]=o,e.length>2&&(e[2]=.5*(i[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,Fe),e)}unprojectFromRenderScreen(t,e){if(Ke(me,this.projectionMatrix,this.viewMatrix),!ie(me,me))return null;const i=this.fullViewport;return v[0]=2*(t[0]-i[0])/i[2]-1,v[1]=2*(t[1]-i[1])/i[3]-1,v[2]=2*t[2]-1,v[3]=1,he(v,v,me),v[3]===0?null:(e[0]=v[0]/v[3],e[1]=v[1]/v[3],e[2]=v[2]/v[3],e)}constrainWindowSize(t,e,i,r){const s=t*this.pixelRatio,o=e*this.pixelRatio,a=Math.max(s-i/2,0),l=Math.max(this.fullHeight-o-r/2,0),n=-Math.min(s-i/2,0),c=-Math.min(this.fullHeight-o-r/2,0),h=i-n- -Math.min(this.fullWidth-s-i/2,0),u=r-c- -Math.min(o-r/2,0);return[Math.round(a),Math.round(l),Math.round(h),Math.round(u)]}computeUp(t){t===ni.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){const i=t[0]*this.pixelRatio,r=this.fullHeight-t[1]*this.pixelRatio;return e[0]=i,e[1]=r,e}renderToScreen(t,e){const i=t[0]/this.pixelRatio,r=(this.fullHeight-t[1])/this.pixelRatio;e[0]=i,e[1]=r}_computeUpGlobal(){_e(R,this.center,this.eye);const t=Q(this.center);t<1?(W(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(Ne(R,this.center))>.9999*Q(R)*t||(rt(this._up,R,this.center),rt(this._up,this._up,R),xe(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){li(R,this.eye,this.center),Math.abs(R[2])<=.9999&&(U(R,R,R[2]),W(this._up,-R[0],-R[1],1-R[2]),xe(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(t,e,i=""){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?le(t,e)||(G(e,t),this._markViewDirty(),i.length&&this.notifyChange(i)):hi.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(cr(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(ci(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};p([m()],g.prototype,"_viewport",void 0),p([m()],g.prototype,"_padding",void 0),p([m()],g.prototype,"_fov",void 0),p([m()],g.prototype,"_nearFar",void 0),p([m()],g.prototype,"_viewDirty",void 0),p([m()],g.prototype,"_viewMatrix",void 0),p([m()],g.prototype,"_pixelRatio",void 0),p([m()],g.prototype,"pixelRatio",null),p([m()],g.prototype,"row",void 0),p([m()],g.prototype,"column",void 0),p([m()],g.prototype,"_rows",void 0),p([m()],g.prototype,"rows",null),p([m()],g.prototype,"_columns",void 0),p([m()],g.prototype,"columns",null),p([m()],g.prototype,"eye",null),p([m()],g.prototype,"center",null),p([m()],g.prototype,"_center",void 0),p([m()],g.prototype,"up",null),p([m()],g.prototype,"_up",void 0),p([m()],g.prototype,"viewMatrix",null),p([m({readOnly:!0})],g.prototype,"viewForward",null),p([m({readOnly:!0})],g.prototype,"viewUp",null),p([m({readOnly:!0})],g.prototype,"viewRight",null),p([m({readOnly:!0})],g.prototype,"nearFar",null),p([m()],g.prototype,"near",null),p([m()],g.prototype,"far",null),p([m()],g.prototype,"viewport",null),p([m({readOnly:!0})],g.prototype,"screenViewport",null),p([m({readOnly:!0})],g.prototype,"screenPadding",null),p([m()],g.prototype,"x",null),p([m()],g.prototype,"y",null),p([m()],g.prototype,"width",null),p([m()],g.prototype,"height",null),p([m()],g.prototype,"fullWidth",null),p([m()],g.prototype,"fullHeight",null),p([m({readOnly:!0})],g.prototype,"_aspect",null),p([m()],g.prototype,"padding",null),p([m({readOnly:!0})],g.prototype,"projectionMatrix",null),p([m({readOnly:!0})],g.prototype,"inverseProjectionMatrix",null),p([m()],g.prototype,"fov",null),p([m()],g.prototype,"fovX",null),p([m()],g.prototype,"fovY",null),p([m()],g.prototype,"viewInverseTransposeMatrix",null),p([m({readOnly:!0})],g.prototype,"_projectionMatrixInternal",null),p([m()],g.prototype,"relativeElevation",void 0),g=Ge=p([Mt("esri.views.3d.webgl.RenderCamera")],g);const Ks=g,v=J(),me=N(),R=j(),ze=j(),Fe=ui();let eo=class extends ur{};const jt=128,Lt=.5;function io(t){return t==="cross"||t==="x"}function ro(t,e=jt,i=e*Lt,r=0){const s=Nr(t,e,i,r);return new $i(s,{mipmap:!1,wrap:{s:st.CLAMP_TO_EDGE,t:st.CLAMP_TO_EDGE},width:e,height:e,components:4,noUnpackFlip:!0,reloadable:!0})}function Nr(t,e=jt,i=e*Lt,r=0){switch(t){case"circle":default:return Gr(e,i);case"square":return Ur(e,i);case"cross":return Wr(e,i,r);case"x":return kr(e,i,r);case"kite":return qr(e,i);case"triangle":return Yr(e,i);case"arrow":return Xr(e,i)}}function Gr(t,e){const i=t/2-.5;return oe(t,Vt(i,i,e/2))}function Ur(t,e){return Bt(t,e,!1)}function qr(t,e){return Bt(t,e,!0)}function Wr(t,e,i=0){return Ht(t,e,!1,i)}function kr(t,e,i=0){return Ht(t,e,!0,i)}function Yr(t,e){return oe(t,Nt(t/2,e,e/2))}function Xr(t,e){const i=e,r=e/2,s=t/2,o=.8*i,a=Vt(s,(t-e)/2-o,Math.sqrt(o*o+r*r)),l=Nt(s,i,r);return oe(t,(n,c)=>Math.max(l(n,c),-a(n,c)))}function Bt(t,e,i){return i&&(e/=Math.SQRT2),oe(t,(r,s)=>{let o=r-.5*t+.25,a=.5*t-s-.75;if(i){const l=(o+a)/Math.SQRT2;a=(a-o)/Math.SQRT2,o=l}return Math.max(Math.abs(o),Math.abs(a))-.5*e})}function Ht(t,e,i,r=0){e-=r,i&&(e*=Math.SQRT2);const s=.5*e;return oe(t,(o,a)=>{let l,n=o-.5*t,c=.5*t-a-1;if(i){const h=(n+c)/Math.SQRT2;c=(c-n)/Math.SQRT2,n=h}return n=Math.abs(n),c=Math.abs(c),l=n>c?n>s?Math.sqrt((n-s)*(n-s)+c*c):c:c>s?Math.sqrt(n*n+(c-s)*(c-s)):n,l-=r/2,l})}function Vt(t,e,i){return(r,s)=>{const o=r-t,a=s-e;return Math.sqrt(o*o+a*a)-i}}function Nt(t,e,i){const r=Math.sqrt(e*e+i*i);return(s,o)=>{const a=Math.abs(s-t)-i,l=o-t+e/2+.75,n=(e*a+i*l)/r,c=-l;return Math.max(n,c)}}function oe(t,e){const i=new Uint8Array(4*t*t);for(let r=0;r<t;r++)for(let s=0;s<t;s++){const o=s+t*r;let a=e(s,r);a=a/t+.5,dr(a,i,4*o)}return i}function Qr(t){return t instanceof Float32Array&&t.length>=16}function Zr(t){return Array.isArray(t)&&t.length>=16}function Jr(t){return Qr(t)||Zr(t)}class Kr{constructor(){this.factor=new yt,this.factorAlignment=new yt}}let yt=class{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}};function es(t,e){const{vertex:i,fragment:r}=t;t.include(Pi,e),i.include(It),e.terrainDepthTest&&t.varyings.add("depth","float"),i.main.add(w`
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${e.terrainDepthTest?w`depth = projectAux.posView.z;`:""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  `),r.main.add(w`fragColor = vec4(1);
if(terrainDepthTest(depth)) {
fragColor.g = 0.5;
}`)}const We={occludedFadeFactor:.6};function Gt(t){const e=new Di,i=t.signedDistanceFieldEnabled;if(e.include(gr,t),e.include(Ai,t),t.occlusionPass)return e.include(es,t),e;const{vertex:r,fragment:s}=e;e.include(Ei),e.include(Ri,t),e.include(Ii,t),e.include(mr),s.include(vr),s.include(zi),e.varyings.add("vcolor","vec4"),e.varyings.add("vtc","vec2"),e.varyings.add("vsize","vec2"),e.varyings.add("voccluded","float"),r.uniforms.add(new ue("viewport",(h,u)=>u.camera.fullViewport),new nt("screenOffset",(h,u)=>be(Ut,2*h.screenOffset[0]*u.camera.pixelRatio,2*h.screenOffset[1]*u.camera.pixelRatio)),new nt("anchorPosition",h=>se(h)),new ue("materialColor",h=>h.color),new Pe("materialRotation",h=>h.rotation)),Fi(r),i&&(r.uniforms.add(new ue("outlineColor",h=>h.outlineColor)),s.uniforms.add(new ue("outlineColor",h=>xt(h)?h.outlineColor:di),new Pe("outlineSize",h=>xt(h)?h.outlineSize:0))),t.horizonCullingEnabled&&r.uniforms.add(new Cr("pointDistanceSphere",(h,u)=>{const f=u.camera.eye,d=h.origin;return Ve(d[0]-f[0],d[1]-f[1],d[2]-f[2],pi.radius)})),t.pixelSnappingEnabled&&r.include(It),t.hasScreenSizePerspective&&(ji(r),Li(r)),t.debugDrawLabelBorder&&e.varyings.add("debugBorderCoords","vec4"),e.attributes.add(x.UV0,"vec2"),e.attributes.add(x.COLOR,"vec4"),e.attributes.add(x.SIZE,"vec2"),e.attributes.add(x.ROTATION,"float"),e.attributes.add(x.FEATUREATTRIBUTE,"vec4"),r.code.add(t.horizonCullingEnabled?w`bool behindHorizon(vec3 posModel) {
vec3 camToEarthCenter = pointDistanceSphere.xyz - localOrigin;
vec3 camToPos = pointDistanceSphere.xyz + posModel;
float earthRadius = pointDistanceSphere.w;
float a = dot(camToPos, camToPos);
float b = dot(camToPos, camToEarthCenter);
float c = dot(camToEarthCenter, camToEarthCenter) - earthRadius * earthRadius;
return  b > 0.0 && b < a && b * b  > a * c;
}`:w`bool behindHorizon(vec3 posModel) { return false; }`),r.main.add(w`
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      forwardObjectAndLayerIdColor();

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }

      if (behindHorizon(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }

      vec2 inputSize;
      ${E(t.hasScreenSizePerspective,w`
          inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
          vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);`,w`
          inputSize = size;
          vec2 screenOffsetScaled = screenOffset;`)}
      ${E(t.vvSize,w`inputSize *= vvScale(featureAttribute).xx;`)}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);
      bool visible = testHUDVisibility(posProj);
      voccluded = visible ? 0.0 : 1.0;
    `);const o=w`
      vec2 uv01 = floor(uv0);
      vec2 uv = uv0 - uv01;
      quadOffset.xy = (uv01 - anchorPosition) * 2.0 * combinedSize;

      ${E(t.hasRotation,w`
          float angle = radians(materialRotation + rotation);
          float cosAngle = cos(angle);
          float sinAngle = sin(angle);
          mat2 rotate = mat2(cosAngle, -sinAngle, sinAngle,  cosAngle);

          quadOffset.xy = rotate * quadOffset.xy;
        `)}

      quadOffset.xy = (quadOffset.xy + screenOffsetScaled) / viewport.zw * posProj.w;
  `,a=t.pixelSnappingEnabled?i?w`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:w`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:w`posProj += quadOffset;`;r.main.add(w`
    ${E(t.occlusionTestEnabled,w`
      if (!visible) {
        vtc = vec2(0.0);
        ${E(t.debugDrawLabelBorder,"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);")}
        return;
      }`)}
    ${o}
    ${t.vvColor?"vcolor = interpolateVVColor(featureAttribute.y) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${E(t.output===z.ObjectAndLayerIdColor,w`vcolor.a = 1.0;`)}

    bool alphaDiscard = vcolor.a < ${w.float(k)};
    ${E(i,`alphaDiscard = alphaDiscard && outlineColor.a < ${w.float(k)};`)}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${a}
      gl_Position = posProj;
    }

    vtc = uv;

    ${E(t.debugDrawLabelBorder,w`debugBorderCoords = vec4(uv01, 1.5 / combinedSize);`)}
    vsize = inputSize;
  `),s.uniforms.add(new lt("tex",h=>h.texture)),t.occludedFragmentFade&&(s.uniforms.add(new lt("depthMap",(h,u)=>u.mainDepth)),s.uniforms.add(new Pe("fadeFactor",()=>We.occludedFadeFactor)));const l=t.debugDrawLabelBorder?w`(isBorder > 0.0 ? 0.0 : ${w.float(k)})`:w.float(k),n=t.output===z.Highlight,c=w`
    ${E(t.debugDrawLabelBorder,w`float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`)}

    ${E(t.sampleSignedDistanceFieldTexelCenter,w`
      float txSize = float(textureSize(tex, 0).x);
      float texelSize = 1.0 / txSize;

      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;`,w`vec2 samplePos = vtc;`)}

    ${i?w`
      vec4 fillPixelColor = vcolor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${l} ||
          fillPixelColor.a + outlinePixelColor.a < ${w.float(k)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        ${E(!n,w`fragColor = vec4(compositeColor, compositeAlpha);`)}
      } else {
        if (fillAlphaFactor < ${l}) {
          discard;
        }

        ${E(!n,w`fragColor = premultiplyAlpha(fillPixelColor);`)}
      }

      // visualize SDF:
      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:w`
          vec4 texColor = texture(tex, vtc, -0.5);
          if (texColor.a < ${l}) {
            discard;
          }
          ${E(!n,w`fragColor = texColor * premultiplyAlpha(vcolor);`)}
          `}

    ${E(t.occludedFragmentFade&&!n,w`
        float zSample = texelFetch(depthMap, ivec2(gl_FragCoord.xy), 0).x;
        if (zSample < gl_FragCoord.z) {
          fragColor *= fadeFactor;
        }
        `)}

    ${E(!n&&t.debugDrawLabelBorder,w`fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`)}
  `;switch(t.output){case z.Color:t.oitPass===re.ColorAlpha&&(e.outputs.add("fragColor","vec4",0),e.outputs.add("fragAlpha","float",1)),s.main.add(w`
        ${c}
        ${E(t.oitPass===re.FrontFace,w`fragColor.rgb /= fragColor.a;`)}
        ${E(t.oitPass===re.ColorAlpha,w`fragAlpha = fragColor.a;`)}`);break;case z.ObjectAndLayerIdColor:s.main.add(w`
        ${c}
        outputObjectAndLayerIdColor();`);break;case z.Highlight:e.include(Bi,t),s.main.add(w`
        ${c}
        outputHighlight(voccluded == 1.0);`)}return e}function xt(t){return t.outlineColor[3]>0&&t.outlineSize>0}function se(t,e=Ut){return t.textureIsSignedDistanceField?ts(t.anchorPosition,t.distanceFieldBoundingBox,e):At(e,t.anchorPosition),e}function ts(t,e,i){e!=null?be(i,t[0]*(e[2]-e[0])+e[0],t[1]*(e[3]-e[1])+e[1]):be(i,0,0)}const Ut=Ue(),is=Object.freeze(Object.defineProperty({__proto__:null,build:Gt,calculateAnchorPosForRendering:se,shaderSettings:We},Symbol.toStringTag,{value:"Module"}));class rs extends Hi{constructor(e,i,r){super(e,i,new Vi(is,()=>fi(()=>Promise.resolve().then(()=>vs),void 0,import.meta.url)),r),this.primitiveType=i.occlusionPass?ot.POINTS:ot.TRIANGLES}initializePipeline(e){const{oitPass:i,hasPolygonOffset:r,draped:s,output:o,depthTestEnabled:a}=e,l=i===re.NONE,n=r?ss:null,c=i===re.ColorAlpha,h=s||!a||c||o===z.Highlight?null:wr;return yr({blending:o===z.Color?l?xr:Ni(i):null,depthTest:a&&!s?{func:gi.LEQUAL}:null,depthWrite:h,drawBuffers:Gi(i,o),colorWrite:br,polygonOffset:n})}}const ss={factor:0,units:-4};class D extends Ui{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hasRotation=!1,this.debugDrawLabelBorder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthTestEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.occlusionPass=!1,this.occludedFragmentFade=!1,this.objectAndLayerIdColorInstanced=!1,this.horizonCullingEnabled=!0,this.textureCoordinateType=qi.None,this.emissionSource=Wi.None,this.discardInvisibleFragments=!0,this.hasSliceInVertexProgram=!0,this.hasVvInstancing=!1}}p([A()],D.prototype,"screenCenterOffsetUnitsEnabled",void 0),p([A()],D.prototype,"occlusionTestEnabled",void 0),p([A()],D.prototype,"signedDistanceFieldEnabled",void 0),p([A()],D.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),p([A()],D.prototype,"vvSize",void 0),p([A()],D.prototype,"vvColor",void 0),p([A()],D.prototype,"hasVerticalOffset",void 0),p([A()],D.prototype,"hasScreenSizePerspective",void 0),p([A()],D.prototype,"hasRotation",void 0),p([A()],D.prototype,"debugDrawLabelBorder",void 0),p([A()],D.prototype,"hasSlicePlane",void 0),p([A()],D.prototype,"hasPolygonOffset",void 0),p([A()],D.prototype,"depthTestEnabled",void 0),p([A()],D.prototype,"pixelSnappingEnabled",void 0),p([A()],D.prototype,"draped",void 0),p([A()],D.prototype,"terrainDepthTest",void 0),p([A()],D.prototype,"cullAboveTerrain",void 0),p([A()],D.prototype,"occlusionPass",void 0),p([A()],D.prototype,"occludedFragmentFade",void 0),p([A()],D.prototype,"objectAndLayerIdColorInstanced",void 0),p([A()],D.prototype,"horizonCullingEnabled",void 0);class oo extends ki{constructor(e,i){super(e,fs),this.produces=new Map([[q.HUD_MATERIAL,r=>$e(r)&&!this.parameters.drawInSecondSlot],[q.LABEL_MATERIAL,r=>$e(r)&&this.parameters.drawInSecondSlot],[q.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[q.DRAPED_MATERIAL,r=>this.parameters.draped&&$e(r)]]),this._visible=!0,this._configuration=new D(i)}getConfiguration(e,i){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen",this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.hasRotation=this.parameters.hasRotation,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=i.slot===q.OCCLUSION_PIXELS,this._configuration.occludedFragmentFade=this.parameters.occludedFragmentFade,this._configuration.horizonCullingEnabled=this.parameters.horizonCullingEnabled,this._configuration.depthTestEnabled=this.parameters.depthEnabled||i.slot===q.OCCLUSION_PIXELS,e===z.Color&&(this._configuration.debugDrawLabelBorder=!!Yi.LABELS_SHOW_BORDER),this._configuration.oitPass=i.oitPass,this._configuration.terrainDepthTest=i.terrainDepthTest,this._configuration.cullAboveTerrain=i.cullAboveTerrain,this._configuration}intersect(e,i,r,s,o,a){const{options:{selectionMode:l,hud:n,excludeLabels:c},point:h,camera:u}=r,{parameters:f}=this;if(!l||!n||c&&f.isLabel||!e.visible||!h)return;const{scaleX:d,scaleY:_}=this._getScreenScale(e,u.pixelRatio);Et(Le,i),e.attributes.has(x.FEATUREATTRIBUTE)&&ns(Le);const y=e.attributes.get(x.POSITION),O=e.attributes.get(x.SIZE),S=e.attributes.get(x.NORMAL),M=e.attributes.get(x.ROTATION),T=e.attributes.get(x.CENTEROFFSETANDDISTANCE);ye(y.size>=3);const C=se(f),P=this.parameters.centerOffsetUnits==="screen";for(let $=0;$<y.data.length/y.size;$++){const H=$*y.size;W(I,y.data[H],y.data[H+1],y.data[H+2]),we(I,I,i),we(I,I,u.viewMatrix);const Ce=$*T.size;if(W(B,T.data[Ce],T.data[Ce+1],T.data[Ce+2]),!P&&(I[0]+=B[0],I[1]+=B[1],B[2]!==0)){const ae=B[2];xe(B,I),_e(I,I,U(B,B,ae))}const Se=$*S.size;if(W(ee,S.data[Se],S.data[Se+1],S.data[Se+2]),bt(ee,Le,u,He),this._applyVerticalOffsetTransformationView(I,He,u,je),u.applyProjection(I,F),F[0]>-1){P&&(B[0]||B[1])&&(F[0]+=B[0]*u.pixelRatio,B[1]!==0&&(F[1]+=Xi(B[1],je.factorAlignment)*u.pixelRatio),u.unapplyProjection(F,I)),F[0]+=this.parameters.screenOffset[0]*u.pixelRatio,F[1]+=this.parameters.screenOffset[1]*u.pixelRatio,F[0]=Math.floor(F[0]),F[1]=Math.floor(F[1]);const ae=$*O.size;L[0]=O.data[ae],L[1]=O.data[ae+1],Qi(L,je.factor,L);const kt=us*u.pixelRatio;let ke=0;f.textureIsSignedDistanceField&&(ke=Math.min(f.outlineSize,.5*L[0])*u.pixelRatio/2),L[0]*=d,L[1]*=_;const Yt=$*M.size,Xt=f.rotation+M.data[Yt];if(Ot(h,F[0],F[1],L,kt,ke,Xt,f,C)){const Ye=r.ray;if(we(Ct,I,ie(hs,u.viewMatrix)),F[0]=h[0],F[1]=h[1],u.unprojectFromRenderScreen(F,I)){const K=j();G(K,Ye.direction);const Xe=1/Q(K);U(K,K,Xe),a(Dt(Ye.origin,I)*Xe,K,-1,!0,1,Ct)}}}}}intersectDraped(e,i,r,s,o,a){const l=e.attributes.get(x.POSITION),n=e.attributes.get(x.SIZE),c=e.attributes.get(x.ROTATION),h=this.parameters,u=se(h),{scaleX:f,scaleY:d}=this._getScreenScale(e,e.screenToWorldRatio),_=ds*e.screenToWorldRatio;for(let y=0;y<l.data.length/l.size;y++){const O=y*l.size,S=l.data[O],M=l.data[O+1],T=y*n.size;L[0]=n.data[T],L[1]=n.data[T+1];let C=0;h.textureIsSignedDistanceField&&(C=Math.min(h.outlineSize,.5*L[0])*e.screenToWorldRatio/2),L[0]*=f,L[1]*=d;const P=y*c.size,$=h.rotation+c.data[P];Ot(s,S,M,L,_,C,$,h,u)&&o(a.dist,a.normal,-1,!1)}}createBufferWriter(){return new ms}_updateScaleInfo(e,i,r){const s=this.parameters;s.screenSizePerspective!=null?ht(r,i,s.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minScaleFactor=0),s.screenSizePerspectiveAlignment!=null?ht(r,i,s.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minScaleFactor=e.factor.minScaleFactor)}applyShaderOffsetsView(e,i,r,s,o,a,l){const n=bt(i,r,o,He);return this._applyVerticalGroundOffsetView(e,n,o,l),this._applyVerticalOffsetTransformationView(l,n,o,a),this._applyPolygonOffsetView(l,n,s[3],o,l),this._applyCenterOffsetView(l,s,l),l}applyShaderOffsetsNDC(e,i,r,s,o){return this._applyCenterOffsetNDC(e,i,r,s),o!=null&&G(o,s),this._applyPolygonOffsetNDC(s,i,r,s),s}_applyPolygonOffsetView(e,i,r,s,o){const a=s.aboveGround?1:-1;let l=Math.sign(r);l===0&&(l=a);const n=a*l;if(this.parameters.shaderPolygonOffset<=0)return G(o,e);const c=mi(Math.abs(i.cosAngle),.01,1),h=1-Math.sqrt(1-c*c)/c/s.viewport[2];return U(o,e,n>0?h:1/h),o}_applyVerticalGroundOffsetView(e,i,r,s){const o=Q(e),a=r.aboveGround?1:-1,l=r.computeRenderPixelSizeAtDist(o)*_r,n=U(I,i.normal,a*l);return Me(s,e,n),s}_applyVerticalOffsetTransformationView(e,i,r,s){var c;const o=this.parameters;if(!((c=o.verticalOffset)!=null&&c.screenLength)){if(o.screenSizePerspective||o.screenSizePerspectiveAlignment){const h=Q(e);this._updateScaleInfo(s,h,i.cosAngle)}else s.factor.scale=1,s.factorAlignment.scale=1;return e}const a=Q(e),l=o.screenSizePerspectiveAlignment??o.screenSizePerspective,n=Zi(r,a,o.verticalOffset,i.cosAngle,l);return this._updateScaleInfo(s,a,i.cosAngle),U(i.normal,i.normal,n),Me(e,e,i.normal)}_applyCenterOffsetView(e,i,r){const s=this.parameters.centerOffsetUnits!=="screen";return r!==e&&G(r,e),s&&(r[0]+=i[0],r[1]+=i[1],i[2]&&(xe(ee,r),Me(r,r,U(ee,ee,i[2])))),r}_applyCenterOffsetNDC(e,i,r,s){const o=this.parameters.centerOffsetUnits!=="screen";return s!==e&&G(s,e),o||(s[0]+=i[0]/r.fullWidth*2,s[1]+=i[1]/r.fullHeight*2),s}_applyPolygonOffsetNDC(e,i,r,s){const o=this.parameters.shaderPolygonOffset;if(e!==s&&G(s,e),o){const a=r.aboveGround?1:-1,l=a*Math.sign(i[3]);s[2]-=(l||a)*o}return s}set visible(e){this._visible=e}get visible(){const{color:e,outlineSize:i,outlineColor:r}=this.parameters,s=e[3]>=k||i>=k&&r[3]>=k;return this._visible&&s}createGLMaterial(e){return new os(e)}calculateRelativeScreenBounds(e,i,r=vi()){return as(this.parameters,e,i,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r}_getScreenScale(e,i){const r=e.attributes.get(x.FEATUREATTRIBUTE);if(r==null)return{scaleX:i,scaleY:i};const s=_i(r.data,cs);return Ji(Be,this.parameters,s),{scaleX:Be[0]*i,scaleY:Be[1]*i}}}class os extends Ki{constructor(e){super({...e,...e.material.parameters})}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.acquireTechnique(rs,e)}}function as(t,e,i,r){r[0]=t.anchorPosition[0]*-e[0]+t.screenOffset[0]*i,r[1]=t.anchorPosition[1]*-e[1]+t.screenOffset[1]*i}function bt(t,e,i,r){return Jr(e)&&(e=Et(ls,e)),wi(r.normal,t,e),we(r.normal,r.normal,i.viewInverseTransposeMatrix),r.cosAngle=Ne(qt,ps),r}function ns(t){const e=t[0],i=t[1],r=t[2],s=t[3],o=t[4],a=t[5],l=t[6],n=t[7],c=t[8],h=1/Math.sqrt(e*e+i*i+r*r),u=1/Math.sqrt(s*s+o*o+a*a),f=1/Math.sqrt(l*l+n*n+c*c);return t[0]=e*h,t[1]=i*h,t[2]=r*h,t[3]=s*u,t[4]=o*u,t[5]=a*u,t[6]=l*f,t[7]=n*f,t[8]=c*f,t}function Ot(t,e,i,r,s,o,a,l,n){let c=e-s-r[0]*n[0],h=c+r[0]+2*s,u=i-s-r[1]*n[1],f=u+r[1]+2*s;const d=l.distanceFieldBoundingBox;return l.textureIsSignedDistanceField&&d!=null&&(c+=r[0]*d[0],u+=r[1]*d[1],h-=r[0]*(1-d[2]),f-=r[1]*(1-d[3]),c-=o,h+=o,u-=o,f+=o),be(St,e,i),yi(te,t,St,xi(a)),te[0]>c&&te[0]<h&&te[1]>u&&te[1]<f}const je=new Kr,I=j(),ee=j(),F=J(),qt=j(),Ct=j(),te=Ue(),St=Ue(),Le=Rt(),ls=Rt(),hs=N(),B=j(),Be=j(),cs=J(),He={normal:qt,cosAngle:0},us=1,ds=2,L=[0,0],ps=bi(0,0,1);class fs extends er{constructor(){super(...arguments),this.renderOccluded=tr.Occlude,this.isDecoration=!1,this.color=at(1,1,1,1),this.polygonOffset=!1,this.anchorPosition=Pt(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=at(1,1,1,1),this.outlineSize=0,this.rotation=0,this.hasRotation=!1,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.occludedFragmentFade=!1,this.horizonCullingEnabled=!1,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.draped=!1,this.isLabel=!1}}const Wt=fr().vec3f(x.POSITION).vec3f(x.NORMAL).vec2f(x.UV0).vec4u8(x.COLOR).vec2f(x.SIZE).f32(x.ROTATION).vec4f(x.CENTEROFFSETANDDISTANCE).vec4f(x.FEATUREATTRIBUTE),gs=Wt.clone().vec4u8(x.OBJECTANDLAYERIDCOLOR);class ms{constructor(){this.vertexBufferLayout=ir()?gs:Wt}elementCount(e){return 6*e.get(x.POSITION).indices.length}write(e,i,r,s,o,a){var M,T;rr(r.get(x.POSITION),e,o.position,a,6),sr(r.get(x.NORMAL),i,o.normal,a,6);const l=(M=r.get(x.UV0))==null?void 0:M.data;let n=0,c=0,h=1,u=1;l&&l.length>=4&&(n=l[0],c=l[1],h=l[2],u=l[3]),h=Math.min(1.99999,h+1),u=Math.min(1.99999,u+1);let f=r.get(x.POSITION).indices.length,d=a;const _=o.uv0;for(let C=0;C<f;++C)_.set(d,0,n),_.set(d,1,c),d++,_.set(d,0,h),_.set(d,1,c),d++,_.set(d,0,h),_.set(d,1,u),d++,_.set(d,0,h),_.set(d,1,u),d++,_.set(d,0,n),_.set(d,1,u),d++,_.set(d,0,n),_.set(d,1,c),d++;or(r.get(x.COLOR),4,o.color,a,6);const{data:y,indices:O}=r.get(x.SIZE);f=O.length;const S=o.size;d=a;for(let C=0;C<f;++C){const P=y[2*O[C]],$=y[2*O[C]+1];for(let H=0;H<6;++H)S.set(d,0,P),S.set(d,1,$),d++}if(ar(r.get(x.ROTATION),o.rotation,a,6),r.get(x.CENTEROFFSETANDDISTANCE)?ct(r.get(x.CENTEROFFSETANDDISTANCE),o.centerOffsetAndDistance,a,6):ut(o.centerOffsetAndDistance,a,6*f),r.get(x.FEATUREATTRIBUTE)?ct(r.get(x.FEATUREATTRIBUTE),o.featureAttribute,a,6):ut(o.featureAttribute,a,6*f),s!=null){const C=(T=r.get(x.POSITION))==null?void 0:T.indices;if(C){const P=C.length,$=o.getField(x.OBJECTANDLAYERIDCOLOR,pr);nr(s,$,P,a,6)}}}}const vs=Object.freeze(Object.defineProperty({__proto__:null,build:Gt,calculateAnchorPosForRendering:se,shaderSettings:We},Symbol.toStringTag,{value:"Module"}));export{dt as E,Y as I,vt as V,Pr as a,ro as b,oo as c,io as d,Lt as e,Mr as f,jt as g,Ks as i,Js as n,Ls as o,eo as r,Ys as s,$r as t,Tr as u,Ae as x};
