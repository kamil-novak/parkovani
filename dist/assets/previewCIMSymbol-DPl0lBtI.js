import{dL as w,eW as b,f4 as V,eV as v,f0 as $,f5 as j}from"./index-DlYLAng9.js";import{e as g}from"./CIMSymbolHelper-DjPta98G.js";import{CIMSymbolRasterizer as G}from"./CIMSymbolRasterizer-DDkyORPm.js";import"./BidiEngine-DNnuvc1i.js";import"./fontUtils-BD4sdIhk.js";import"./GeometryUtils-Cq9CNqLc.js";import"./Rect-CUzevAry.js";import"./BoundingBox-Bc4_8-kv.js";import"./CIMResourceManager-YQDcbSJA.js";const f=new G(null),u=w(b.size),S=w(b.maxSize),C=w(b.lineWidth),O=1;async function R(i,e,r){const l=e==null?void 0:e.size;let t=l!=null&&typeof l=="object"&&"width"in l?l.width:l,n=l!=null&&typeof l=="object"&&"height"in l?l.height:l;if(t==null||n==null)if(r==="esriGeometryPolygon")t=u,n=u;else{const a=await q(i,e,r);a&&(t=a.width,n=a.height),r==="esriGeometryPolyline"&&(t=C),t=t!=null&&isFinite(t)?Math.min(t,S):u,n=n!=null&&isFinite(n)?Math.max(Math.min(n,S),O):u}return e.style==="legend"&&r==="esriGeometryPolyline"&&(t=C),{width:t,height:n}}async function q(i,e,r){const{feature:l,fieldMap:t,viewParams:n}=e.cimOptions||e,a=await j.resolveSymbolOverrides(i.data,l,null,t,r,null,n);if(!a)return null;(i=i.clone()).data={type:"CIMSymbolReference",symbol:a},i.data.primitiveOverrides=void 0;const o=[];return g.fetchResources(a,f.resourceManager,o),g.fetchFonts(a,f.resourceManager,o),o.length>0&&await Promise.all(o),g.getEnvelope(a,null,f.resourceManager)}async function J(i,e={}){var M;const{node:r,opacity:l,symbolConfig:t}=e,n=t!=null&&typeof t=="object"&&"isSquareFill"in t&&t.isSquareFill,a=e.cimOptions||e,o=a.geometryType||V((M=i==null?void 0:i.data)==null?void 0:M.symbol),h=await R(i,e,o),{feature:L,fieldMap:P}=a,I=n||o!=="esriGeometryPolygon"?"preview":"legend",y=await f.rasterizeCIMSymbolAsync(i,L,h,I,P,o,null,a.viewParams,a.allowScalingUp);if(!y)return null;const{width:x,height:z}=y,c=document.createElement("canvas");c.width=x,c.height=z,c.getContext("2d").putImageData(y,0,0);const p=v(h.width),d=v(h.height),s=new Image(p,d);s.src=c.toDataURL(),s.ariaLabel=e.ariaLabel??null,s.alt=e.ariaLabel??"",l!=null&&(s.style.opacity=`${l}`);let m=s;if(e.effectView!=null){const F={shape:{type:"image",x:0,y:0,width:p,height:d,src:s.src},fill:null,stroke:null,offset:[0,0]};m=$([[F]],[p,d],{effectView:e.effectView,ariaLabel:e.ariaLabel})}return r&&m&&r.appendChild(m),m}export{J as previewCIMSymbol};
